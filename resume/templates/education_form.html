{% load crispy_forms_tags %}
  <script src="https://unpkg.com/htmx.org@2.0.3"></script>

<div class="page-container">
    <form method="post">
        {% csrf_token %}

        <section class="education-section">
            <h2>Education</h2>
            <div id="education-container">
                {{ education_formset.management_form }}
                {% for form in education_formset %}
                    <div class="education-form card">
                        {{ form|crispy }}
                        <div class="card-buttons">
                            <div class="my-indicator"></div>
                            <button type="button"
                                    class="btn btn-primary enhance-education"
                                    hx-post="{% url 'resume:enhance_education' %}"
                                    hx-trigger="click"
                                    hx-vals='{"field_id": "{{ form.field_of_study.id_for_label }}"}'
                                    hx-target="#{{ form.field_of_study.id_for_label }}"
                                    hx-swap="outerHTML"
                                    hx-indicator=".my-indicator"
                            >Enhance
                            </button>
                            <button type="button"
                                    class="btn btn-danger remove-education"
                            >Remove</button>
                        </div>
                    </div>
                {% endfor %}
                <button type="button" id="add-education" class="btn btn-primary">Add Education</button>
            </div>
        </section>

        <br><br>
        <button type="submit" class="btn btn-success">Submit</button>
    </form>
</div>

<!-- Education form template -->
<template id="education-form-template">
    <div class="education-form card">
        {{ education_formset.empty_form|crispy }}
        <div class="card-buttons">
            <div class="my-indicator"></div>
            <button type="button"
                    class="btn btn-primary enhance-education"
                    hx-post="{% url 'resume:enhance_education' %}"
                    hx-trigger="click"
                    hx-vals='{"field_id": "{{ education_formset.empty_form.field_of_study.id_for_label }}"}'
                    hx-target="#{{ education_formset.empty_form.field_of_study.id_for_label }}"
                    hx-swap="outerHTML"
                    hx-indicator=".my-indicator"
            >Enhance
            </button>
            <button type="button"
                    class="btn btn-danger remove-education"
            >Remove</button>
        </div>
    </div>
</template>

<style>
    .page-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
    }

    .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        background-color: #f9f9f9;
        position: relative;
    }

    .card-buttons {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 10px;
    }

    .my-indicator {
        display: none;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin .5s linear infinite;
    }

    .my-indicator{
        display:none;
    }
    .htmx-request .my-indicator{
        display:inline;
    }
    .htmx-request.my-indicator{
        display:inline;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @media (max-width: 840px) {
        .page-container {
            padding: 0 15px;
        }
    }
</style>

<script>
    const EDUCATION_SELECTORS = {
        form: '.education-form',
        container: '#education-container',
        addButton: '#add-education',
        totalForms: '#id_education-TOTAL_FORMS',
        template: '#education-form-template'
    }

    const educationElements = {
        forms: document.querySelectorAll(EDUCATION_SELECTORS.form),
        container: document.querySelector(EDUCATION_SELECTORS.container),
        addButton: document.querySelector(EDUCATION_SELECTORS.addButton),
        totalForms: document.querySelector(EDUCATION_SELECTORS.totalForms),
        template: document.querySelector(EDUCATION_SELECTORS.template)
    }

    let educationFormIndex = educationElements.forms.length - 1
    let educationFormCount = educationElements.forms.length

    educationElements.addButton.addEventListener('click', addEducationForm)

    function addEducationForm(e) {
        e.preventDefault()

        try {
            const template = educationElements.template
            const newForm = template.content.cloneNode(true)

            educationFormIndex++
            educationFormCount++
            newForm.querySelector('.education-form').innerHTML =
                newForm.querySelector('.education-form').innerHTML.replace(
                    RegExp('education-__prefix__-', 'g'),
                    `education-${educationFormIndex}-`
            )

            educationElements.container.insertBefore(newForm, educationElements.addButton)
            educationElements.totalForms.setAttribute('value', `${educationFormCount}`)
            
            // reload htmx to recognize new form
            htmx.process(educationElements.container);

        } catch (error) {
            console.error('Error adding education form:', error)
        }
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-education')) {
            e.target.closest('.card').remove()
            
            // After a form is deleted, reassign the id's of the remaining forms in order
            const forms = document.querySelectorAll('.education-form')
            forms.forEach((form, index) => {
                form.innerHTML = form.innerHTML.replace(
                    RegExp('education-\\d+-', 'g'),
                    `education-${index}-`
                )
            })

            // Update total forms count
            educationElements.totalForms.setAttribute('value', forms.length)
            educationFormIndex = forms.length - 1
            educationFormCount = forms.length
        }
    });
</script>
