{% load static %}
<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dashboard - ResuStack</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#2563eb", /* Login page blue */
                    "primary-hover": "#1d4ed8",
                    "background-light": "#f1f5f9",
                    "background-dark": "#0f172a",
                },
                fontFamily: {
                    "display": ["Inter", "sans-serif"],
                    "sans": ["Inter", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.375rem", 
                    "lg": "0.5rem", 
                    "xl": "0.75rem", 
                    "full": "9999px"
                },
            },
        },
    }
</script>
<style type="text/tailwindcss">
    @layer base {
        body {
            @apply font-display bg-background-light text-slate-900;
        }
    }
    .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        font-size: 20px;
    }
    
    /* Message animations */
    @keyframes fadeInSlide {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
    .message-toast {
        animation: fadeInSlide 0.3s ease-out;
    }
    .message-toast.fade-out {
        animation: fadeOut 0.3s ease-out forwards;
    }
</style>
</head>
<body class="min-h-screen">
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden">
    <!-- Header -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-slate-200 bg-white px-4 md:px-10 lg:px-20 py-4 z-10 sticky top-0">
        <div class="flex items-center gap-3">
            <img src="{% static 'img/resustack_logo.png' %}" alt="ResuStack Logo" class="h-8 w-auto object-contain"/>
            <h2 class="text-slate-900 text-2xl font-bold tracking-tight">ResuStack</h2>
        </div>
        
        <div class="flex flex-1 justify-end gap-8">
            <nav class="hidden md:flex items-center gap-6">
                <a class="text-primary text-sm font-semibold" href="{% url 'resume:dashboard' %}">Dashboard</a>
                <a class="text-slate-500 text-sm font-medium hover:text-primary transition-colors" href="mailto:koksalkapucuoglu@gmail.com">Help</a>
            </nav>
            
            <div class="flex items-center gap-4">
                <a href="{% url 'profile' %}" class="w-9 h-9 rounded-full bg-slate-200 flex items-center justify-center text-slate-600 font-bold border border-slate-300 hover:bg-primary hover:text-white hover:border-primary transition-all" title="Profile">
                    {{ user.username|slice:":1"|upper }}
                </a>
                <a href="{% url 'logout' %}" class="flex items-center gap-1 text-slate-500 text-sm font-medium hover:text-red-500 transition-colors">
                    <span class="material-symbols-outlined text-lg">logout</span>
                    <span class="hidden sm:inline">Logout</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="px-4 md:px-10 lg:px-20 flex flex-1 justify-center py-10">
        <div class="flex flex-col max-w-[1200px] flex-1">
            
            <!-- Page Header -->
            <div class="flex flex-wrap items-end justify-between gap-4 mb-6">
                <div class="flex flex-col gap-1">
                    <h1 class="text-slate-900 text-3xl font-black tracking-tight">My Resumes</h1>
                    <p class="text-slate-500 text-sm">Manage and organize your professional documents</p>
                </div>
                <!-- New Resume Button -->
                <a href="{% url 'resume:selection_page' %}" class="flex min-w-[140px] items-center justify-center gap-2 rounded-lg h-11 px-6 bg-primary text-white text-sm font-bold tracking-wide hover:bg-primary-hover transition-all shadow-lg shadow-primary/20">
                    <span class="material-symbols-outlined">add</span>
                    <span class="truncate">New Resume</span>
                </a>
            </div>

            <!-- Messages -->
            {% if messages %}
            <div class="mb-6 space-y-3 relative z-[9999]" id="messagesContainer">
                {% for message in messages %}
                <div class="message-toast flex items-center gap-3 p-4 rounded-lg border {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% elif message.tags == 'warning' %}bg-yellow-50 border-yellow-200 text-yellow-800{% else %}bg-blue-50 border-blue-200 text-blue-800{% endif %}" role="alert">
                    <span class="material-symbols-outlined !text-[20px]">
                        {% if message.tags == 'success' %}check_circle{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}
                    </span>
                    <span class="flex-1 text-sm font-medium">{{ message }}</span>
                    <button onclick="dismissMessage(this.parentElement)" class="p-1 rounded hover:bg-black/10 transition-colors">
                        <span class="material-symbols-outlined !text-[18px]">close</span>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Resume Grid -->
            {% if resumes %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    {% for resume in resumes %}
                    <div class="group flex flex-col rounded-xl border border-slate-200 bg-white overflow-hidden hover:shadow-xl hover:shadow-slate-200/50 transition-all duration-300">
                        <!-- Preview Image Area -->
                        <div class="relative w-full bg-slate-50 aspect-[3/4.2] overflow-hidden border-b border-slate-100 group">
                            <!-- Placeholder specific for PDF/Resume look -->
                            <div class="absolute inset-0 p-6 flex flex-col gap-2 opacity-50 select-none pointer-events-none bg-white">
                                <div class="w-1/2 h-4 bg-slate-200 rounded mb-4"></div>
                                <div class="w-full h-2 bg-slate-200 rounded"></div>
                                <div class="w-full h-2 bg-slate-200 rounded"></div>
                                <div class="w-3/4 h-2 bg-slate-200 rounded"></div>
                                <div class="w-full h-px bg-slate-100 my-4"></div>
                                <div class="w-1/3 h-3 bg-slate-200 rounded mb-2"></div>
                                <div class="w-full h-2 bg-slate-200 rounded"></div>
                                <div class="w-full h-2 bg-slate-200 rounded"></div>
                            </div>

                            <!-- Hover Overlay -->
                            <div class="absolute inset-0 bg-slate-900/0 group-hover:bg-slate-900/10 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100 backdrop-blur-[1px]">
                                <a href="{% url 'resume:resume_form_edit' pk=resume.pk %}" class="bg-white text-slate-900 px-5 py-2.5 rounded-lg font-bold text-sm shadow-md hover:scale-105 transition-transform">
                                    Edit Document
                                </a>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="p-5 flex flex-col gap-4">
                            <div class="flex flex-col gap-1">
                                <h3 class="text-slate-900 text-base font-bold leading-tight truncate" title="{{ resume.display_name }}">
                                    {{ resume.display_name }}
                                </h3>
                                {% if resume.owner_name %}
                                <p class="text-slate-600 text-sm truncate">
                                    {{ resume.owner_name }}
                                </p>
                                {% endif %}
                                <div class="flex items-center gap-2 text-[11px] text-slate-400 mt-1">
                                    <span>Created {{ resume.created_at|date:"M d, Y" }}</span>
                                    <span>â€¢</span>
                                    <span>Edited {{ resume.updated_at|timesince }} ago</span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex items-center justify-between pt-4 border-t border-slate-100">
                                <div class="flex gap-1">
                                    <!-- Duplicate Button -->
                                    <button type="button"
                                            onclick="showConfirmModal('duplicate', '{{ resume.pk }}', '{{ resume.display_name|escapejs }}')"
                                            class="p-2 rounded-md text-slate-400 hover:text-primary hover:bg-primary/10 transition-colors"
                                            title="Duplicate">
                                        <span class="material-symbols-outlined !text-[18px]">content_copy</span>
                                    </button>
                                    <!-- Download PDF Button -->
                                    <a href="{% url 'resume:download_resume_pdf' resume.pk %}"
                                       class="download-btn flex items-center gap-1 px-2.5 py-1.5 rounded-md text-slate-500 hover:text-primary hover:bg-primary/10 transition-colors text-xs font-medium"
                                       title="Download PDF"
                                       onclick="this.innerHTML='<span class=\'material-symbols-outlined animate-spin !text-[16px]\'>autorenew</span>'; this.style.pointerEvents='none'; setTimeout(()=>{this.innerHTML='<span class=\'material-symbols-outlined !text-[16px]\'>download</span> PDF'; this.style.pointerEvents=\'auto\';}, 4000);">
                                        <span class="material-symbols-outlined !text-[16px]">download</span> PDF
                                    </a>
                                </div>
                                <!-- Delete Button -->
                                <button type="button"
                                        onclick="showConfirmModal('delete', '{{ resume.pk }}', '{{ resume.display_name|escapejs }}')"
                                        class="p-2 rounded-md text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors"
                                        title="Delete">
                                    <span class="material-symbols-outlined !text-[18px]">delete</span>
                                </button>
                            </div>
                            
                            <!-- Hidden Forms -->
                            <form id="duplicate-form-{{ resume.pk }}" method="post" action="{% url 'resume:duplicate_resume' pk=resume.pk %}" class="hidden">
                                {% csrf_token %}
                            </form>
                            <form id="delete-form-{{ resume.pk }}" method="post" action="{% url 'resume:delete_resume' pk=resume.pk %}" class="hidden">
                                {% csrf_token %}
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="flex flex-col items-center justify-center py-20 text-center border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50/50">
                    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-sm mb-4">
                        <span class="material-symbols-outlined text-slate-400 text-3xl">post_add</span>
                    </div>
                    <h3 class="text-lg font-bold text-slate-900 mb-1">No resumes yet</h3>
                    <p class="text-slate-500 mb-6 max-w-xs">Create your first professional resume in minutes with our AI tools.</p>
                    <a href="{% url 'resume:selection_page' %}" class="px-6 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-primary-hover transition-colors shadow-sm">
                        Create New Resume
                    </a>
                </div>
            {% endif %}
            
        </div>
    </main>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 z-50 hidden">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="hideConfirmModal()"></div>
        
        <!-- Modal Content -->
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full transform transition-all duration-300 scale-95 opacity-0" id="modalContent">
                <!-- Modal Header -->
                <div class="p-6 pb-4">
                    <div class="flex items-center gap-4">
                        <div id="modalIcon" class="w-12 h-12 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-2xl" id="modalIconSymbol"></span>
                        </div>
                        <div class="flex-1">
                            <h3 id="modalTitle" class="text-lg font-bold text-slate-900"></h3>
                            <p id="modalSubtitle" class="text-sm text-slate-500 mt-0.5"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="px-6 pb-4">
                    <p id="modalMessage" class="text-slate-600 text-sm leading-relaxed"></p>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex gap-3 p-6 pt-4 border-t border-slate-100">
                    <button onclick="hideConfirmModal()" 
                            class="flex-1 px-4 py-2.5 rounded-lg border border-slate-200 text-slate-600 font-medium text-sm hover:bg-slate-50 transition-colors">
                        Cancel
                    </button>
                    <button id="modalConfirmBtn" onclick="confirmAction()"
                            class="flex-1 px-4 py-2.5 rounded-lg font-medium text-sm text-white transition-colors">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-auto border-t border-slate-200 bg-white py-8 px-4 md:px-10 lg:px-20">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 max-w-[1200px] mx-auto w-full">
            <div class="flex items-center gap-2">
                <img src="{% static 'img/resustack_logo.png' %}" alt="Logo" class="w-4 h-4 object-contain grayscale opacity-50"/>
                <span class="text-sm font-bold tracking-tight text-slate-400">ResuStack</span>
            </div>
            <p class="text-slate-400 text-xs font-medium">Â© 2026 ResuStack. All rights reserved.</p>
        </div>
    </footer>
</div>

<script>
    let currentAction = null;
    let currentResumeId = null;
    
    const modalConfig = {
        duplicate: {
            icon: 'content_copy',
            iconBg: 'bg-blue-100',
            iconColor: 'text-blue-600',
            title: 'Duplicate Resume',
            subtitle: '',
            message: 'A copy of this resume will be created. You will be redirected to edit the new copy.',
            btnText: 'Duplicate',
            btnClass: 'bg-primary hover:bg-primary-hover'
        },
        delete: {
            icon: 'delete',
            iconBg: 'bg-red-100',
            iconColor: 'text-red-600',
            title: 'Delete Resume',
            subtitle: '',
            message: 'This resume will be permanently deleted. This action cannot be undone.',
            btnText: 'Delete',
            btnClass: 'bg-red-500 hover:bg-red-600'
        }
    };
    
    function showConfirmModal(action, resumeId, resumeName) {
        currentAction = action;
        currentResumeId = resumeId;
        
        const config = modalConfig[action];
        config.subtitle = resumeName;
        
        // Update modal content
        document.getElementById('modalIconSymbol').textContent = config.icon;
        document.getElementById('modalIcon').className = `w-12 h-12 rounded-full flex items-center justify-center ${config.iconBg}`;
        document.getElementById('modalIconSymbol').className = `material-symbols-outlined text-2xl ${config.iconColor}`;
        document.getElementById('modalTitle').textContent = config.title;
        document.getElementById('modalSubtitle').textContent = config.subtitle;
        document.getElementById('modalMessage').textContent = config.message;
        document.getElementById('modalConfirmBtn').textContent = config.btnText;
        document.getElementById('modalConfirmBtn').className = `flex-1 px-4 py-2.5 rounded-lg font-medium text-sm text-white transition-colors ${config.btnClass}`;
        
        // Show modal
        const modal = document.getElementById('confirmModal');
        const content = document.getElementById('modalContent');
        modal.classList.remove('hidden');
        
        // Animate in
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }
    
    function hideConfirmModal() {
        const modal = document.getElementById('confirmModal');
        const content = document.getElementById('modalContent');
        
        // Animate out
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            currentAction = null;
            currentResumeId = null;
        }, 200);
    }
    
    function confirmAction() {
        if (currentAction && currentResumeId) {
            const form = document.getElementById(`${currentAction}-form-${currentResumeId}`);
            if (form) {
                form.submit();
            }
        }
    }
    
    // Close on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideConfirmModal();
        }
    });
    
    // Message dismiss functions
    function dismissMessage(element) {
        element.classList.add('fade-out');
        setTimeout(() => {
            element.remove();
            // Remove container if empty
            const container = document.getElementById('messagesContainer');
            if (container && container.children.length === 0) {
                container.remove();
            }
        }, 300);
    }
    
    // Auto-dismiss messages after 5 seconds; error toasts stay until manually closed
    document.addEventListener('DOMContentLoaded', () => {
        const messages = document.querySelectorAll('.message-toast');
        messages.forEach((msg, index) => {
            const isError = msg.classList.contains('bg-red-50');
            if (!isError) {
                setTimeout(() => {
                    if (msg.parentElement) {
                        dismissMessage(msg);
                    }
                }, 5000 + (index * 500)); // Stagger dismissal
            }
        });
    });
</script>
<!-- Feedback Widget -->
<div id="feedback-widget" class="fixed bottom-6 right-6 z-50">
  <!-- Trigger Button -->
  <button onclick="document.getElementById('feedback-modal').classList.remove('hidden')"
          class="bg-primary hover:bg-primary-hover text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 text-sm font-medium transition-all hover:shadow-xl">
    <span class="material-symbols-outlined text-base">feedback</span>
    Feedback
  </button>

  <!-- Modal -->
  <div id="feedback-modal" class="hidden fixed inset-0 bg-black/40 z-50 flex items-end justify-end p-6">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-slate-900 font-semibold text-lg">Share Feedback</h3>
        <button onclick="document.getElementById('feedback-modal').classList.add('hidden')"
                class="text-slate-400 hover:text-slate-600">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <!-- Star Rating -->
      <div class="mb-4">
        <p class="text-slate-600 text-sm mb-2">How would you rate your experience?</p>
        <div class="flex gap-1" id="star-rating">
          {% for i in "12345" %}
          <button type="button" class="star-btn text-slate-300 hover:text-yellow-400 transition-colors"
                  data-value="{{ forloop.counter }}"
                  onclick="setRating({{ forloop.counter }})">
            <span class="material-symbols-outlined" style="font-size:28px;">star</span>
          </button>
          {% endfor %}
        </div>
        <input type="hidden" id="feedback-rating" value="">
      </div>

      <!-- Message -->
      <textarea id="feedback-message" rows="3"
                placeholder="Tell us what you think..."
                class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-700 resize-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent mb-4"></textarea>

      <!-- Submit via fetch -->
      <button onclick="submitFeedback()"
              id="feedback-submit-btn"
              class="w-full bg-primary hover:bg-primary-hover text-white py-2 rounded-lg text-sm font-medium transition-colors">
        Send Feedback
      </button>
      <div id="feedback-success" class="hidden text-center text-green-600 font-medium mt-2">
        Thank you for your feedback! ðŸŽ‰
      </div>
    </div>
  </div>
</div>

<script>
function setRating(value) {
  document.getElementById('feedback-rating').value = value;
  document.querySelectorAll('.star-btn').forEach((btn, idx) => {
    btn.style.color = idx < value ? '#facc15' : '';
  });
}

function submitFeedback() {
  const message = document.getElementById('feedback-message').value.trim();
  if (!message) { alert('Please enter a message.'); return; }
  const rating = document.getElementById('feedback-rating').value;
  const btn = document.getElementById('feedback-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Sending...';

  fetch('/api/v1/feedback/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
    body: JSON.stringify({message, rating: rating ? parseInt(rating) : null, page: window.location.pathname})
  })
  .then(r => r.json())
  .then(() => {
    document.getElementById('feedback-success').classList.remove('hidden');
    btn.classList.add('hidden');
    setTimeout(() => document.getElementById('feedback-modal').classList.add('hidden'), 2000);
  })
  .catch(() => { btn.disabled = false; btn.textContent = 'Send Feedback'; alert('Error. Please try again.'); });
}

function getCookie(name) {
  return document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith(name+'='))?.split('=')[1] || '';
}
</script>
</body>
</html>
